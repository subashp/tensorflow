#
# Copyright 2018, Nod Labs
#
# standalone unit test for XLA. original code is under:
# tensorflow/tensorflow/compiler/aot/tests/nodcompile_test.cc

SILENT := @
CPP := g++
CPPFLAGS := -g -std=c++11
DEFINES :=

# due to all the shenanigans of the protobuf, we will use the compiler
# and the library TF folks build. If you got something that can create
# conflict, remove from the PATH
export PATH := bazel-out/host/bin/external/protobuf_archive:$(PATH)

# This should be equivalent to LD_LIBRARY_PATH from the shell
LDFLAGS := -Wl,-rpath,bazel-bin/tensorflow/compiler/tf2xla,-rpath,bazel-bin/tensorflow/compiler/aot,-rpath,bazel-bin/tensorflow/compiler/xla/service/cpu,-rpath,bazel-bin/tensorflow/compiler/xla

TF_ROOT = /home/subash/deep_learning/tensorflow

VPATH := .

INCLUDES := -I.
INCLUDES += -Ibazel-tensorflow
INCLUDES += -Ibazel-genfiles
INCLUDES += -Ibazel-tensorflow/external/eigen_archive
INCLUDES += -Ibazel-tensorflow/external/boringssl/src/third_party/googletest/include
INCLUDES += -Ibazel-tensorflow/external/protobuf_archive/src
INCLUDES += -Ibazel-tensorflow/external/nsync/public
INCLUDES += -Ibazel-genfiles/tensorflow/compiler/xla

LIB_PATH := -Lbazel-bin/tensorflow/compiler/tf2xla
LIB_PATH += -Lbazel-bin/tensorflow/compiler/aot
LIB_PATH += -Lbazel-bin/tensorflow/compiler/xla/service/cpu
LIB_PATH += -Lbazel-bin/tensorflow/compiler/xla

LIBS := -lxla_compiled_cpu_function
LIBS += -lruntime
LIBS += -lruntime_matmul
LIBS += -lruntime_matvec
LIBS += -lexecutable_run_options
LIBS += -lpthread

SRC := nod_tfcompile_test.cc

BIN := MatMul

OBJS := $(patsubst %.cc,%.o,$(SRC))

%.o: %.cc
	$(SILENT) $(CPP) $(CPPFLAGS) $(INCLUDES) -c $< -o $@

all: clean build

# generated by: bazel build tensorflow/compiler/aot:tfcompile
tf_compile:
	$(TF_ROOT)/bazel-bin/tensorflow/compiler/aot/tfcompile --graph="test_graph_tfmatmul.pb" --config="test_graph_tfmatmul.config.pbtxt" --cpp_class="testgraph::MatMul"

$(BIN): tf_compile out_helper.o out_model.o $(OBJS)
	$(SILENT) $(CPP) $(CPPFLAGS) $(OBJS) out_helper.o out_model.o $(LIB_PATH) $(LIBS) $(LDFLAGS) -o $@

build: $(BIN)
.PHONY: build

clean:
	-$(SILENT) rm $(BIN) *.o
.PHONY: clean

# This can be executed only once - broken - python is not being invoked
# from inside the Makefile
gen_graph:
	cd $(TF_ROOT)/tensorflow/compiler/aot/tests
	python3 make_test_graphs.py
	cp test_graph_tfmatmul.pb $(TF_ROOT)
	cp test_graph_tfmatmul.config.pbtxt $(TF_ROOT)
	cd -
.PHONY: gen_graph
